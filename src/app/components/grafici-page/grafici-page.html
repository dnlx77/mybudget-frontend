<div class="grafici-container">

    <div class="page-header">
        <h1>ðŸ“Š Analisi Finanziaria</h1>
        <p class="subtitle">Analizza l'andamento delle tue finanze</p>
    </div>

    <div class="filtri-section">

        <div class="quick-filters">
            <button class="btn-quick" (click)="impostaPeriodo('ultimi7')">ðŸ“… 7 Giorni</button>
            <button class="btn-quick" (click)="impostaPeriodo('ultimi30')">ðŸ“… 30 Giorni</button>
            <button class="btn-quick" (click)="impostaPeriodo('questoMese')">ðŸ“… Questo Mese</button>
            <button class="btn-quick" (click)="impostaPeriodo('questoAnno')">ðŸ“… Quest'Anno</button>
        </div>

        <div class="custom-filters">
            <div class="form-group">
                <label>Data Inizio</label>
                <input type="date" [ngModel]="dataInizio()" (ngModelChange)="dataInizio.set($event)"
                    class="form-control" />
            </div>

            <div class="form-group">
                <label>Data Fine</label>
                <input type="date" [ngModel]="dataFine()" (ngModelChange)="dataFine.set($event)" class="form-control" />
            </div>

            <div class="form-group">
                <label>Conto</label>
                <select [ngModel]="contoId()" (ngModelChange)="contoId.set($event)" class="form-control">
                    <option [ngValue]="null">Tutti i conti (Patrimonio Totale)</option>
                    @for (conto of conti(); track conto.id) {
                    <option [ngValue]="conto.id">{{ conto.nome }}</option>
                    }
                </select>
            </div>

            <div class="form-actions">
                <button class="btn-secondary" (click)="resetFiltri()">ðŸ”„ Reset</button>
            </div>
        </div>
    </div>

    @if (loading()) {
    <div class="loading-section">
        <div class="spinner"></div>
        <p>Analisi in corso...</p>
    </div>
    }

    @if (!loading()) {

    <div class="info-section">
        <div class="info-card">
            <span class="info-label">Periodo Analizzato</span>
            <span class="info-value">{{ statsSpeseTag().periodo }}</span>
        </div>
        <div class="info-card">
            <span class="info-label">Totale Uscite</span>
            <span class="info-value totale">â‚¬{{ statsSpeseTag().totale | number:'1.2-2' }}</span>
        </div>
    </div>
    }

    <div class="charts-grid">

        <div class="chart-card">
            <div class="chart-title">
                <h3>Spese per Categoria</h3>
            </div>

            @if (statsSpeseTag().totale > 0) {
            <div echarts [options]="pieChartOption()" [autoResize]="true" class="chart-container"></div>

            <div class="chart-stats">
                <div class="stat">
                    <span class="stat-label">Totale</span>
                    <span class="stat-value">â‚¬{{ statsSpeseTag().totale | number:'1.0-0' }}</span>
                </div>
            </div>
            } @else {
            <div class="placeholder-content">
                <span class="placeholder-icon">ðŸ“‰</span>
                <p class="placeholder-subtitle">Nessuna spesa nel periodo</p>
            </div>
            }
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <h3>Entrate vs Uscite</h3>
            </div>

            @if (statsGuadagniVsSpese(); as stats) {
            <div echarts [options]="barChartOption()" [autoResize]="true" class="chart-container"></div>

            <div class="chart-stats">
                <div class="stat">
                    <span class="stat-label">Entrate</span>
                    <span class="stat-value positive">â‚¬{{ stats.totale_guadagni | number:'1.0-0' }}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Saldo</span>
                    <span class="stat-value" [class.positive]="stats.saldo_netto > 0"
                        [class.negative]="stats.saldo_netto < 0">
                        â‚¬{{ stats.saldo_netto | number:'1.0-0' }}
                    </span>
                </div>
            </div>
            } @else {
            <div class="placeholder-content">
                <span class="placeholder-icon">ðŸ“Š</span>
                <p class="placeholder-subtitle">Dati insufficienti</p>
            </div>
            }
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <h3>{{ contoId() ? 'Andamento Saldo Conto' : 'Patrimonio Totale' }}</h3>
            </div>

            @if (statsAndamento(); as stats) {
            <div echarts [options]="lineChartOption()" [autoResize]="true" class="chart-container"></div>

            <div class="chart-stats">
                <div class="stat">
                    <span class="stat-label">Inizio</span>
                    <span class="stat-value">â‚¬{{ stats.saldo_iniziale | number:'1.0-0' }}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Fine</span>
                    <span class="stat-value">â‚¬{{ stats.saldo_finale | number:'1.0-0' }}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Variazione</span>
                    <span class="stat-value" [class.positive]="stats.variazione > 0"
                        [class.negative]="stats.variazione < 0">
                        â‚¬{{ stats.variazione | number:'1.0-0' }}
                    </span>
                </div>
            </div>
            } @else {
            <div class="placeholder-content">
                <span class="placeholder-icon">ðŸ“ˆ</span>
                <p class="placeholder-subtitle">Nessun dato nel periodo</p>
            </div>
            }
        </div>

    </div>
</div>