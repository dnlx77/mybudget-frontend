<!-- Modal Backdrop -->
@if (isOpen) {
<div class="modal-backdrop" (click)="onClose()"></div>
}

<!-- Modal -->
@if (isOpen) {
<div class="modal-container">
    <div class="modal-content">

        <!-- Header -->
        <div class="modal-header">
            @if (isEditMode) {
            <h2>Modifica Operazione</h2>
            } @else {
            <h2>Nuova Operazione</h2>
            }
            <button class="close-btn" (click)="onClose()">✕</button>
        </div>

        <!-- Body -->
        <div class="modal-body">

            <!-- Errore -->
            @if (error) {
            <div class="alert alert-error">
                {{ error }}
            </div>
            }

            <!-- Success -->
            @if (success) {
            <div class="alert alert-success">
                {{ success }}
            </div>
            }

            <!-- Loading Data -->
            @if (loadingConti || loadingTags) {
            <p class="loading-text">Caricamento dati...</p>
            } @else {

            <!-- Form -->
            <form (ngSubmit)="onSubmit()">

                <!-- Data Operazione -->
                <div class="form-group">
                    <label for="data">Data Operazione *</label>
                    <input id="data" type="date" [(ngModel)]="data_operazione" name="data_operazione"
                        [max]="getTodayDate()" required [disabled]="loading" />
                </div>

                <!-- Conto Origine -->
                <div class="form-group">
                    <label for="conto">Conto *</label>
                    <select id="conto" [(ngModel)]="conto_id" name="conto_id" required [disabled]="loading">
                        <option [value]="null">Seleziona un conto</option>
                        @for (conto of conti; track conto.id) {
                        <option [value]="conto.id">{{ conto.nome }}</option>
                        }
                    </select>
                </div>

                <!-- Conto Destinazione (opzionale - trasferimenti) -->
                <div class="form-group">
                    <label for="conto-dest">Conto Destinazione (opzionale)</label>
                    <select id="conto-dest" [(ngModel)]="conto_destinazione_id" name="conto_destinazione_id"
                        [disabled]="loading || !conto_id">
                        <option [value]="null">- Nessun trasferimento -</option>
                        @for (conto of conti; track conto.id) {
                        @if (conto.id !== conto_id) {
                        <option [value]="conto.id">{{ conto.nome }}</option>
                        }
                        }
                    </select>
                </div>

                <!-- Importo -->
                <div class="form-group">
                    <label for="importo">Importo * (negativo=spesa, positivo=entrata)</label>
                    <input id="importo" type="number" step="0.01" [(ngModel)]="importo" name="importo"
                        placeholder="Es: -50.50 o 100.00" required [disabled]="loading" />
                </div>

                <!-- Descrizione -->
                <div class="form-group">
                    <label for="descrizione">Descrizione *</label>
                    <textarea id="descrizione" [(ngModel)]="descrizione" name="descrizione"
                        placeholder="Es: Spesa alimentari al supermercato" rows="3" required
                        [disabled]="loading"></textarea>
                </div>

                <!-- Tag Search -->
                <div class="form-group">
                    <label for="tag-search">Tag</label>
                    <div class="tag-search-container">

                        <!-- Selected Tags as Chips -->
                        <div class="selected-tags-inline">
                            @for (tag of selectedTags; track tag.id) {
                            <span class="tag-badge-inline">
                                {{ tag.nome }}
                                <button type="button" class="remove-tag-btn" (click)="removeTag(tag.id)"
                                    [disabled]="loading">
                                    ✕
                                </button>
                            </span>
                            }
                        </div>

                        <!-- Search Input -->
                        <input id="tag-search" type="text" class="tag-search-input" [(ngModel)]="tagSearchInput"
                            (input)="onTagSearchInput(tagSearchInput)" name="tagSearch"
                            placeholder="Digita per cercare tag..." [disabled]="loading" autocomplete="off" />
                    </div>

                    <!-- Tag Suggestions -->
                    @if (showTagSuggestions && filteredTags.length > 0) {
                    <div class="tag-suggestions">
                        @for (tag of filteredTags; track tag.id) {
                        <div class="tag-suggestion-item" (click)="selectTag(tag)">
                            {{ tag.nome }}
                        </div>
                        }
                    </div>
                    }
                </div>

            </form>
            }
        </div>

        <!-- Footer -->
        <div class="modal-footer">
            <button class="btn-cancel" (click)="onClose()" [disabled]="loading">
                Annulla
            </button>
            <button class="btn-save" (click)="onSubmit()" [disabled]="loading">
                @if (loading) {
                Salvataggio...
                } @else {
                @if (isEditMode) {
                Aggiorna
                } @else {
                Crea
                }
                }
            </button>
        </div>

    </div>
</div>
}