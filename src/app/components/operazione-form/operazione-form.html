@if (isOpenSignal()) {
<div class="modal-backdrop" (click)="onClose()"></div>
}

@if (isOpenSignal()) {
<div class="modal-container">
    <div class="modal-content">

        <div class="modal-header">
            <h2>{{ isEditMode() ? 'Modifica Operazione' : 'Nuova Operazione' }}</h2>
            <button class="close-btn" (click)="onClose()">✕</button>
        </div>

        <div class="modal-body">

            @if (error()) {
            <div class="alert alert-error">{{ error() }}</div>
            }
            @if (success()) {
            <div class="alert alert-success">{{ success() }}</div>
            }

            @if (conti().length === 0) {
            <p class="loading-text">Caricamento conti e tag...</p>
            } @else {

            <form [formGroup]="form" (ngSubmit)="onSubmit()">

                <div class="form-group">
                    <label for="conto">Conto *</label>
                    <select id="conto" formControlName="conto_id">
                        <option [value]="null">Seleziona un conto</option>
                        @for (conto of conti(); track conto.id) {
                        <option [value]="conto.id">{{ conto.nome }}</option>
                        }
                    </select>
                    @if (form.get('conto_id')?.invalid && form.get('conto_id')?.touched) {
                    <span class="error-text">Il conto è obbligatorio.</span>
                    }
                </div>

                @if (!isEditMode()) {
                <div class="form-group transfer-group">
                    <label for="conto-dest">
                        Conto Destinazione <span class="badge-optional">Opzionale - Trasferimento</span>
                    </label>
                    <select id="conto-dest" formControlName="conto_destinazione_id">
                        <option [value]="null">-- Nessun Trasferimento --</option>
                        @for (conto of conti(); track conto.id) {
                        @if (conto.id != form.get('conto_id')?.value) {
                        <option [value]="conto.id">{{ conto.nome }}</option>
                        }
                        }
                    </select>
                    @if (form.get('conto_destinazione_id')?.hasError('sameAccount')) {
                    <span class="error-text">Il conto di destinazione deve essere diverso.</span>
                    }
                </div>
                }

                <div class="form-row-split">
                    <div class="form-group">
                        <label for="importo">Importo *</label>
                        <input id="importo" type="number" step="0.01" formControlName="importo"
                            placeholder="Es: -50.00 o 100" />
                        @if (form.get('importo')?.invalid && form.get('importo')?.touched) {
                        <span class="error-text">Inserisci un importo valido.</span>
                        }
                    </div>

                    <div class="form-group">
                        <label for="data">Data *</label>
                        <input id="data" type="date" formControlName="data_operazione" [max]="getTodayDate()" />
                        @if (form.get('data_operazione')?.invalid && form.get('data_operazione')?.touched) {
                        <span class="error-text">Data obbligatoria.</span>
                        }
                    </div>
                </div>

                <div class="form-group">
                    <label>Tags *</label>

                    <div class="tag-search-container">

                        <div class="selected-tags-inline">
                            @for (tag of selectedTags(); track tag.id) {
                            <span class="tag-badge-inline">
                                {{ tag.nome }}
                                <button type="button" class="remove-tag-btn" (click)="removeTag(tag.id)">✕</button>
                            </span>
                            }
                        </div>

                        <input type="text" #tagInputRef class="tag-search-input" [formControl]="tagSearchControl" (keydown)="handleInputKeydown($event)"
                            placeholder="Cerca tag..." autocomplete="off" />
                    </div>

                    @if (filteredTags().length > 0) {
                    <div class="tag-suggestions">
                        @for (tag of filteredTags(); track tag.id) {
                        <div class="tag-suggestion-item" tabindex="0" #suggestionItem (click)="selectTag(tag)" (keydown)="handleSuggestionKeydown($event, tag)">
                            {{ tag.nome }}
                        </div>
                        }
                    </div>
                    }

                    @if (selectedTags().length === 0 && form.touched) {
                    <span class="error-text">Seleziona almeno un tag.</span>
                    }
                </div>

                <div class="form-group">
                    <label for="descrizione">Descrizione</label> <textarea id="descrizione" formControlName="descrizione" rows="2"
                        placeholder="Es: Spesa supermercato..."></textarea>
                
                </div>

            </form>
            }
        </div>

        <div class="modal-footer">
            <button class="btn-cancel" (click)="onClose()" [disabled]="loading()">
                Annulla
            </button>
            <button class="btn-save" (click)="onSubmit()" [disabled]="loading()">
                @if (loading()) {
                Salvataggio...
                } @else {
                {{ isEditMode() ? 'Salva Modifiche' : 'Crea Operazione' }}
                }
            </button>
        </div>

    </div>
</div>
}