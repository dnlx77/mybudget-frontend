<div class="operazioni-panel">

  <div class="panel-header">
    <h2>Operazioni</h2>
    <button class="btn-nuova-operazione" (click)="openFormNew()">
      ‚ûï Nuova Operazione
    </button>
  </div>

  <app-operazione-form [isOpen]="isFormOpen" [operazioneEdit]="operazioneEdit" (close)="closeForm()"
    (saved)="onOperazioneSaved()">
  </app-operazione-form>

  <div class="filtri-section">
    <div class="filtri-row">
      <input type="number" [ngModel]="filterAnno()" (ngModelChange)="setFilterAnno($event)" placeholder="Anno"
        class="filtro-input" min="2000" max="2099" />

      <input type="number" [ngModel]="filterMese()" (ngModelChange)="setFilterMese($event)" placeholder="Mese"
        class="filtro-input" min="1" max="12" />

      <input type="date" [ngModel]="filterData()" (ngModelChange)="updateFilter('data', $event)" class="filtro-input" />
    </div>

    <div class="filtri-row">
      <select [ngModel]="filterConto()" (ngModelChange)="updateFilter('conto', $event)"
        class="filtro-input filtro-select">
        <option value="">-- Tutti i Conti --</option>
        @for (conto of conti(); track conto.id) {
        <option [value]="conto.id">{{ conto.nome }}</option>
        }
      </select>

      <div class="tag-filter-container">
        <div class="filtro-input tag-filter-input">

          @if (selectedTagFilter()) {
          <span class="tag-filter-badge">
            {{ selectedTagFilter()?.nome }}
            <button class="btn-clear-tag" (click)="clearTagFilter()">‚úï</button>
          </span>
          }

          <input type="text" [ngModel]="tagSearchInput()" (ngModelChange)="tagSearchInput.set($event)"
            placeholder="Cerca tag..." class="tag-filter-search-input" />
        </div>

        @if (tagSearchInput() && filteredTags().length > 0) {
        <div class="tag-filter-suggestions">
          @for (tag of filteredTags(); track tag.id) {
          <div class="tag-filter-item" (click)="selectTag(tag)">
            {{ tag.nome }}
          </div>
          }
        </div>
        }
      </div>
    </div>
  </div>

  @if (error()) {
  <div class="alert alert-error">
    {{ error() }}
  </div>
  }

  <div class="statistics-section">
    <div class="stat-card guadagno">
      <div class="stat-label">Entrate</div>
      <div class="stat-value">{{ statistiche().guadagno | currencyEuro }}</div>
    </div>

    <div class="stat-card spese">
      <div class="stat-label">Uscite</div>
      <div class="stat-value">{{ statistiche().spese | currencyEuro }}</div>
    </div>

    <div class="stat-card saldo">
      <div class="stat-label">Saldo</div>
      <div class="stat-value" [class.positivo]="statistiche().saldo >= 0" [class.negativo]="statistiche().saldo < 0">
        {{ statistiche().saldo | currencyEuro }}
      </div>
    </div>
  </div>

  @if (isLoading()) {
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Aggiornamento dati...</p>
  </div>
  } @else {

  @if (operazioni().length > 0) {
  <div class="operazioni-table-container">
    <table class="operazioni-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Conto</th>
          <th>Tag</th>
          <th>Descrizione</th>
          <th>Importo</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        @for (op of operazioni(); track op.id) {
        <tr [class.positivo]="op.importo > 0" [class.negativo]="op.importo < 0">
          <td class="data">{{ op.data_operazione | date:'dd/MM/yyyy' }}</td>
          <td class="conto">{{ op.conto?.nome || 'N/A' }}</td>
          <td>
            <div class="tags">
              @for (tag of op.tags; track tag.id) {
              <span class="tag-badge">{{ tag.nome }}</span>
              }
            </div>
          </td>
          <td class="descrizione">
            <span class="desc-text">{{ op.descrizione }}</span>
            @if (op.trasferimento === 'T') {
            <span class="badge-transfer" title="Trasferimento">üîÑ</span>
            }
          </td>
          <td class="importo" [class.positivo]="op.importo > 0" [class.negativo]="op.importo < 0">
            {{ op.importo | currencyEuro }}
          </td>
          <td class="azioni">
            <button class="btn-action btn-edit" (click)="editOperazione(op)">‚úèÔ∏è</button>
            <button class="btn-action btn-delete" (click)="deleteOperazione(op)">üóëÔ∏è</button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <app-pagination [currentPage]="paginationState().current_page" [totalPages]="paginationState().last_page"
    [totalCount]="paginationState().total" (pageChange)="goToPage($event)">
  </app-pagination>

  } @else {
  <div class="no-data">
    <p>Nessuna operazione trovata con i filtri attuali.</p>
  </div>
  }
  }
</div>