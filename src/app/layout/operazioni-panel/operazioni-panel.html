<div class="operazioni-panel">

  <!-- Header -->
  <div class="panel-header">
    <h2>Operazioni</h2>
    <button class="btn-nuova-operazione" (click)="openFormNew()">
      ‚ûï Nuova Operazione
    </button>
  </div>

  <!-- Form Modal -->
  <app-operazione-form [isOpen]="isFormOpen" [operazioneEdit]="operazioneEdit" (close)="closeForm()"
    (saved)="onOperazioneSaved()"></app-operazione-form>

  <!-- Filtri -->
  <div class="filtri-section">
    <div class="filtri-row">
      <input type="number" [(ngModel)]="filterAnno" (change)="onFilterChange()" placeholder="Anno (es: 2025)"
        class="filtro-input" min="2000" max="2099" />
      <input type="number" [(ngModel)]="filterMese" (change)="onFilterChange()" placeholder="Mese (1-12)"
        class="filtro-input" min="1" max="12" />
      <input type="date" [(ngModel)]="filterData" (change)="onFilterChange()" placeholder="Filtro per data"
        class="filtro-input" />
    </div>
  
    <div class="filtri-row">
      <select [(ngModel)]="filterConto" (change)="onFilterChange()" class="filtro-input filtro-select">
        <option value="">-- Seleziona Conto --</option>
        @for (conto of conti; track conto.id) {
        <option [value]="conto.id">{{ conto.nome }}</option>
        }
      </select>
      <!-- Tag Search con Autocomplete -->
      <div class="tag-filter-container">
        <div class="filtro-input tag-filter-input">
          <!-- Tag selezionato dentro l'input -->
          @if (selectedTagFilter) {
          <span class="tag-filter-badge">
            {{ selectedTagFilter.nome }}
            <button class="btn-clear-tag" (click)="clearTagFilter()">‚úï</button>
          </span>
          }
      
          <!-- Input ricerca -->
          <input type="text" [(ngModel)]="tagSearchInput" (input)="onTagSearchInput($event.target.value)"
            placeholder="Ricerca tag..." class="tag-filter-search-input" />
        </div>
      
        @if (tagSearchInput && filteredTags.length > 0) {
        <div class="tag-filter-suggestions">
          @for (tag of filteredTags; track tag.id) {
          <div class="tag-filter-item" (click)="selectTag(tag)">
            {{ tag.nome }}
          </div>
          }
        </div>
        }
      </div>
    </div>
  </div>

  <!-- Errore -->
  @if (error) {
  <div class="alert alert-error">
    {{ error }}
  </div>
  }

  <!-- STATISTICHE -->
  <div class="statistics-section">
    <div class="stat-card guadagno">
      <div class="stat-label">Guadagni</div>
      <div class="stat-value">{{ guadagno | currencyEuro }}</div>
    </div>
  
    <div class="stat-card spese">
      <div class="stat-label">Spese</div>
      <div class="stat-value">{{ spese | currencyEuro }}</div>
    </div>
  
    <div class="stat-card saldo">
      <div class="stat-label">Saldo</div>
      <div class="stat-value" [class.positivo]="saldo > 0" [class.negativo]="saldo < 0">
        {{ saldo | currencyEuro }}
      </div>
    </div>
  </div>

  <!-- Loading -->
  @if (loading) {
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Caricamento operazioni...</p>
  </div>
  } @else {

  <!-- Tabella Operazioni -->
  @if (operazioni.length > 0) {
  <div class="operazioni-table-container">
    <table class="operazioni-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Conto</th>
          <th>Tag</th>
          <th>Descrizione</th>
          <th>Importo</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        @for (op of operazioni; track op.id) {
        <tr [class.positivo]="(op.importo ?? 0) > 0" [class.negativo]="(op.importo ?? 0) < 0">
          <td class="data">{{ op.data_operazione | date:'dd/MM/yyyy' }}</td>
          <td class="conto">{{ op.conto?.nome || 'N/A' }}</td>
          <td>
            @if (op.tags && op.tags.length > 0) {
            <div class="tags">
              @for (tag of op.tags; track tag.id) {
              <span class="tag-badge">{{ tag.nome }}</span>
              }
            </div>
            }
          </td>
          <td class="descrizione">
            <span class="desc-text">{{ op.descrizione }}</span>
          </td>
          <td class="importo" [class.positivo]="(op.importo ?? 0) > 0" [class.negativo]="(op.importo ?? 0) < 0">
            {{ op.importo | currencyEuro }}
          </td>
          <td class="azioni">
            <button class="btn-action btn-edit" title="Modifica" (click)="editOperazione(op)">‚úèÔ∏è</button>
            <button class="btn-action btn-delete" title="Elimina" (click)="deleteOperazione(op)">üóëÔ∏è</button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Paginazione -->
  <app-pagination [currentPage]="currentPage" [totalPages]="totalPages" [totalCount]="totalCount"
    (pageChange)="goToPage($event)"></app-pagination>

  } @else {
  <div class="no-data">
    <p>Nessuna operazione trovata</p>
  </div>
  }

  }
</div>